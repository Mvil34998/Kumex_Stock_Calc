# Kumex: расчёт списания материала (POM) по м² и учёт отхода по толщине

## 0) База склада (как хранит Kumex)
Kumex хранит запас как **10 плит**:

- Размер плиты: **1000 × 2000 × 52 мм**
- Площадь 1 плиты:
  \[
  S_{\text{plate}}=\frac{1000\cdot 2000}{1\,000\,000}=2.0\ \text{м}^2
  \]
- Общая площадь склада:
  \[
  S_{\text{stock}}=2.0\cdot 10=20.0\ \text{м}^2
  \]

### Ключевое правило
**Обрезки/остатки не возвращаются.**  
Материал, снятый по толщине (например, с 52 до 42), считается **отходом** и **не увеличивает остатки**.

---

## 1) Типы позиций в данных (POM.csv)
В данных встречаются **два равноправных типа**:

1) **Штучные позиции (tk)**  
   - `UOM` пустой  
   - `Qty` — количество штук

2) **Метражные позиции (mm)**  
   - `UOM = mm`  
   - `Qty` — длина в миллиметрах (например, `3022 mm`)

---

## 2) Универсальная нормализация ориентации детали на плите 52 мм

### 2.1 Определение толщины детали `t`
Чтобы считать расход по “пятну раскроя”, нужно понять, какая сторона уходит **в толщину плиты**.

**Правило:**
- из трёх размеров `(a, b, c)` выбрать:
  \[
  t = \max(d \mid d \le 52)
  \]
  то есть **самую большую сторону, которая не превышает 52 мм**.

Это согласуется с практикой Kumex: деталь “кладётся” так, чтобы максимально использовать толщину 52 и минимизировать пятно на листе.

### 2.2 Пятно раскроя (footprint)
Две оставшиеся стороны (не равные `t`) образуют прямоугольник “пятна”:
- `p` и `q` — оставшиеся размеры (мм)

---

## 3) Формулы списания по м²

### A) Штучные позиции (tk)
Исход: `a×b×c — N tk`

1) Найти `t = max(d <= 52)`
2) Оставшиеся стороны — `p` и `q`
3) Расход по м²:
   \[
   S=\frac{p\cdot q\cdot N}{1\,000\,000}
   \]

#### Пример A1: `52×42×32 — 10 tk`
- `(a,b,c)=(52,42,32)`
- `t = 52`
- `p=42`, `q=32`
- Расход:
  \[
  S=\frac{42\cdot 32\cdot 10}{1\,000\,000}=0.01344\ \text{м}^2
  \]

---

### B) Метражные позиции (UOM = mm)
Исход: `a×b×c`, а длина хранится в `Qty = L_total (mm)`  
Например: `... Qty = 3022 mm`

1) Найти `t = max(d <= 52)`
2) Из оставшихся двух сторон выбрать **ширину полосы** `w` (это сторона, не являющаяся длиной профиля)
3) Расход по м²:
   \[
   S=\frac{w\cdot L_{\text{total}}}{1\,000\,000}
   \]

> Практически: в “пятне” участвует **ширина** и **фактический метраж**, потому что толщина берётся из 52.

#### Пример B1: `32×42×1000 — 2 tk` (эквивалент через метраж)
Если заказ `32×42×1000 — 2 tk`, то:
- `L_total = 2*1000 = 2000 mm`
- `t = 42` (максимум ≤ 52)
- `w = 32`
- Расход:
  \[
  S=\frac{32\cdot 2000}{1\,000\,000}=0.064\ \text{м}^2
  \]

#### Пример B2: `52×42×1000`, `Qty = 3022 mm`
- `t = 52`
- `w = 42`
- Расход:
  \[
  S=\frac{42\cdot 3022}{1\,000\,000}=0.126924\ \text{м}^2
  \]

---

## 4) Учёт отхода по толщине (не остаток)
Если деталь имеет толщину `t < 52`, то Kumex снимает слой:
\[
\Delta = 52 - t
\]

### Для штучных позиций (tk)
Объём отхода (мм³):
\[
V_{\text{waste}} = (52 - t)\cdot p\cdot q\cdot N
\]

### Для метражных позиций (mm)
Если ширина полосы `w` и общая длина `L_total`:
\[
V_{\text{waste}} = (52 - t)\cdot w\cdot L_{\text{total}}
\]

> Этот отход можно логировать отдельно (для аналитики), но он **не возвращается** в склад.

#### Пример отхода: заказ `32×42×1000 — 2 tk`
- Сначала получают заготовку `32×52×1000`
- Потом снимают `52 → 42`, то есть `Δ = 10`
- `w=32`, `L_total=2000`
- Отход:
  \[
  V_{\text{waste}}=10\cdot 32\cdot 2000=640\,000\ \text{мм}^3
  = 640\ \text{см}^3
  \]

---

## 5) Контрольные проверки (рекомендуется в скрипте)
1) Если среди `(a,b,c)` **нет значения ≤ 52**, то деталь **не из плит 52 мм** → в `issues`.
2) Если рассчитанная ширина/пятно приводит к невозможному раскрою по 1000 мм (например, суммарные полосы > 1000 без учёта раскладки), это отдельный кейс для “packing/nest” или коэффициента отхода.
3) Строки с `Qty <= 0` обрабатывать отдельно:
   - `0` — пропуск/ошибка данных
   - `<0` — корректировка (решить, допускается ли в отчёте)

---

## 6) Итоговый остаток по складу (м²)
Если `S_stock = 20.0 м²`, то после обработки всех позиций:
\[
S_{\text{left}} = 20.0 - \sum S_i
\]

Где `S_i` — расход каждой позиции, рассчитанный по формулам выше.
