# Kumex — расчёты расхода в м² (формулы и пошаговый алгоритм)

Этот документ дополняет `KUMEX_Codex_Rules.md` и фиксирует **все формулы**, которые нужны для расчёта расхода материала в **м²** по правилам Kumex.

---

## 1) Константы склада и процесса

**Склад Kumex (исходник):**
- `PLATE_W_MM = 1000`
- `PLATE_L_MM = 2000`
- `BASE_THICKNESS_MM = 52`
- `STOCK_PLATES = 10`

**Площадь 1 плиты:**
\[
S_{plate} = \frac{PLATE\_W\_MM\cdot PLATE\_L\_MM}{1\,000\,000} = \frac{1000\cdot 2000}{1\,000\,000}=2.0\ \text{м}^2
\]

**Начальный запас:**
\[
S_{stock}=STOCK\_PLATES\cdot S_{plate}=10\cdot 2.0=20.0\ \text{м}^2
\]

**Критическое правило:** обрезки/остатки и снятый слой по толщине **не возвращаются** в остаток.

**Параметр процесса (настройка):**
- `CUT_LEN_MM` — рабочая длина ленты (полосы), из которой режутся детали.
  - по умолчанию `CUT_LEN_MM = 2000` (лента используется по полной длине плиты)
  - допускается `CUT_LEN_MM = 1000` (если фактический техпроцесс приводит ленту к 1000 перед нарезкой)

**Число слоёв на одной плите по длине:**
\[
LAYERS\_PER\_PLATE = \left\lfloor \frac{PLATE\_L\_MM}{CUT\_LEN\_MM} \right\rfloor
\]

---

## 2) Входные данные (Record)

Минимально:
- `dims_mm = [a,b,c]` — размеры в мм
- `uom` — пусто/`"tk"` для штучных, `"mm"` для метражных
- `qty`:
  - если `uom="mm"` → общая длина `L_total_mm`
  - иначе → количество штук `N`

---

## 3) Нормализация геометрии относительно плиты 52 мм

### 3.1 Выбор толщины детали `t`
Толщина детали — это сторона, которую кладут “в толщину” исходной плиты (52 мм).

\[
\text{candidates} = \{d \in \{a,b,c\} : d \le BASE\_THICKNESS\_MM\}
\]

- если `candidates` пусто → `ISSUE_NO_DIM_LE_BASE_THICKNESS`
- иначе:
\[
t = \max(\text{candidates})
\]

**Важно:** число `52` в размерах **не обязано** присутствовать. Например, `42×32×25` корректен: `t=42`.

### 3.2 Footprint на поверхности плиты
Удаляем **один** экземпляр `t` из тройки размеров; две оставшиеся стороны:
- `p` и `q` (мм)

Это прямоугольник footprint на плите.

---

## 4) Преобразование записи в ленты (полосы)

**Лента (полоса):** прямоугольник `w × CUT_LEN_MM`.
- `w` укладывается в ширину плиты 1000 мм
- `CUT_LEN_MM` — рабочая длина (2000 по умолчанию)

### 4.1 Штучные позиции (uom пустой / "tk")
Дано: footprint `p×q`, количество `N`.

Два варианта ориентации резки из ленты:
- Вариант A: `w=p`, `L=q`
- Вариант B: `w=q`, `L=p`

Где `L` — размер детали, который нарезается вдоль длины ленты `CUT_LEN_MM`.

**Проверки выполнимости варианта:**
- `w ≤ PLATE_W_MM`
- `L ≤ CUT_LEN_MM`

**Сколько деталей помещается в одной ленте по длине:**
\[
k = \left\lfloor \frac{CUT\_LEN\_MM}{L} \right\rfloor
\]
Если `k=0` → вариант недопустим.

**Сколько лент нужно:**
\[
strips = \left\lceil \frac{N}{k} \right\rceil
\]

**Суммарная требуемая ширина по этому варианту:**
\[
W_{demand} = strips\cdot w
\]

**Отход по длине внутри лент (из-за округления вверх):**
\[
L_{waste} = strips\cdot CUT\_LEN\_MM - N\cdot L
\]

**Локальный выбор варианта для минимального остатка:**
1) минимизировать `W_demand`
2) при равенстве — минимизировать `L_waste`
3) при равенстве — минимизировать `BASE_THICKNESS_MM - t` (если нужен третий критерий)

**Площадь, требуемая этой позицией в «идеальном» непрерывном учёте (без упаковки):**
\[
S_{ideal} = \frac{strips\cdot w\cdot CUT\_LEN\_MM}{1\,000\,000}\ \text{м}^2
\]

> `S_ideal` полезна для аналитики, но **не является** фактическим списанием склада (склад списывается плитами после упаковки).

### 4.2 Метражные позиции (uom = "mm")
Дано: footprint `p×q`, общая длина `L_total_mm`.

**Ширина ленты:**
\[
w = \min(p,q)
\]

**Сколько лент нужно:**
\[
strips = \left\lceil \frac{L_{total\_mm}}{CUT\_LEN\_MM} \right\rceil
\]

**Отход по длине:**
\[
L_{waste} = strips\cdot CUT\_LEN\_MM - L_{total\_mm}
\]

**Идеальная площадь:**
\[
S_{ideal}=\frac{strips\cdot w\cdot CUT\_LEN\_MM}{1\,000\,000}
\]

---

## 5) Упаковка лент в плиты (фактическое списание склада)

После преобразования всех записей в ленты у нас есть мультисет ширин `w` с кратностью `strips`.

### 5.1 Упаковка лент в «слои» шириной 1000 (FFD)
Один слой — это набор лент, уложенных рядом по ширине в предел `PLATE_W_MM`.

**Алгоритм (First-Fit Decreasing):**
1) развернуть ленты в список ширин (с учётом кратности)
2) сортировать ширины по убыванию
3) класть каждую ленту в первый слой, где она помещается по оставшейся ширине
4) если никуда не помещается — открыть новый слой

Результат:
- `layers_used` — число слоёв

### 5.2 Перевод слоёв в плиты
На одной плите доступно `LAYERS_PER_PLATE` слоёв (по длине).

\[
plates\_used = \left\lceil \frac{layers\_used}{LAYERS\_PER\_PLATE} \right\rceil
\]

Фактическое списание в м²:
\[
S_{used} = plates\_used\cdot S_{plate}
\]

Остаток склада:
\[
plates\_left = STOCK\_PLATES - plates\_used
\]
\[
S_{left} = plates\_left\cdot S_{plate}
\]

### 5.3 Отход по ширине (не возвращается)
Для каждого слоя:
\[
W_{waste} = PLATE\_W\_MM - \sum w_i
\]
Суммарный отход по ширине (мм):
\[
W_{waste\_sum} = \sum W_{waste}
\]

Площадь отхода по ширине (м²):
\[
S_{waste\_width} = \frac{W_{waste\_sum}\cdot CUT\_LEN\_MM}{1\,000\,000}
\]

> Этот KPI полезен, чтобы видеть «эффективность укладки», но в склад **не возвращается**.

---

## 6) Отход по толщине (аналитика, не склад)

Если `t < BASE_THICKNESS_MM`, снимается слой:
\[
\Delta = BASE\_THICKNESS\_MM - t
\]

### 6.1 Для штучных (uom=tk)
Объём снятого слоя (мм³):
\[
V_{waste\_th} = \Delta\cdot p\cdot q\cdot N
\]

### 6.2 Для метражных (uom=mm)
Если `w=min(p,q)` и длина `L_total_mm`:
\[
V_{waste\_th} = \Delta\cdot w\cdot L_{total\_mm}
\]

> Это **не влияет** на м² склада напрямую, но помогает оценить потери материала при «снятии с 52 до t».

---

## 7) Контрольные примеры

### 7.1 Пример (штучная): 52×62×1000, N=2, CUT_LEN=2000
- `t = 52`
- footprint: `62×1000` → `p=62, q=1000`

Вариант A: `w=62, L=1000`
- `k=floor(2000/1000)=2`
- `strips=ceil(2/2)=1`
- `W_demand=62`
- `S_ideal = 1*62*2000/1e6 = 0.124 м²`

Вариант B: `w=1000, L=62`
- `k=floor(2000/62)=32`
- `strips=1`
- `W_demand=1000` (хуже)

Выбор: вариант A.

### 7.2 Пример (без 52 в размерах): 42×32×42, N=25, CUT_LEN=2000
- `t = 42` (максимум ≤ 52)
- footprint: `32×42`

Вариант A: `w=32, L=42`
- `k=floor(2000/42)=47`
- `strips=ceil(25/47)=1`
- `W_demand=32`

Вариант B: `w=42, L=32`
- `k=floor(2000/32)=62`
- `strips=ceil(25/62)=1`
- `W_demand=42`

Выбор: вариант A (в этом примере не требуется 2 ленты, поэтому выигрывает меньшая ширина).

### 7.3 Пример (толщина фиксируется): 102×52×62, N=10
- кандидаты ≤52: только `52` → `t=52`
- footprint: `102×62`
- варианты:
  - A: `w=102, L=62`
  - B: `w=62, L=102`
  (допустимы, т.к. обе стороны ≤ 1000 и ≤ CUT_LEN)

Для `CUT_LEN=2000`:
- A: `k=floor(2000/62)=32`, `strips=1`, `W_demand=102`
- B: `k=floor(2000/102)=19`, `strips=1`, `W_demand=62` → выбрать B

---

## 8) Итоги: что именно считать «расходом м²»

В системе Kumex есть два полезных KPI:

1) **Идеальный расход площади (аналитика):**
   \[
   S_{ideal\_sum} = \sum \frac{strips\cdot w\cdot CUT\_LEN\_MM}{1\,000\,000}
   \]

2) **Фактическое списание склада (по плитам):**
   \[
   S_{used} = plates\_used\cdot 2.0
   \]
   где `plates_used` получен после упаковки лент в слои шириной 1000 и перевода слоёв в плиты.

Рекомендуется выводить **оба** значения, чтобы:
- видеть эффективность раскроя (разницу `S_used - S_ideal_sum`),
- и при этом корректно списывать склад по правилам Kumex.


Note on quantities (bars): if the order line writes the quantity with 'mm' (e.g. '52x42x1000 - 3000mm'), treat qty as total length in millimetres (uom="mm"). If 'mm' is absent, qty is pieces (uom="tk"). Orders can mix both kinds.
