Ниже — готовое содержимое файла **`Kumex_Codex_Utility_Changes.md`**. Скопируй текст целиком в новый `.md` и положи в репозиторий для Codex.

---

# Kumex Stock Calc — Change Request (Codex Instruction)

> **Цель:** внедрить поддержку “реальной даты активности”, перерасчёты **по периоду**, обновить UX журнала/таблиц (Excel-фильтры, контекстное меню), упростить ручные операции со складом.

Документ предназначен как **чёткая инструкция для Codex**: что менять, где менять, какие правила/ограничения соблюдать, какие критерии приёмки.

---

## 0) Термины и константы

* **Плита Kumex (для POM):** `PLATE_W=1000 мм`, `PLATE_L=2000 мм`, `BASE_THICKNESS=52 мм`
* **CUT_LEN_MM** — рабочая длина “ленты” для расчёта конвертации (в UI есть выбор; поведение должно сохраниться).
* **Реальная дата активности (`effective_date`):**

  * для ручного добавления/корректировки склада — **дата заказа/поступления**, которую вводит пользователь;
  * для расчётов по PDF — **дата документа/заказа**, извлечённая из PDF (fallback: выбранный месяц/год или дата создания файла, если дата из PDF не найдена).

---

## 1) Изменение: добавление материала на склад с датой заказа/поступления

### 1.1 UI: форма добавления материала

Добавить в форму ручного внесения материала поле:

* `Order/Arrival date` (формат `dd.mm.yyyy`) — дата, когда материал поступил в Kumex.

**Требование:**

* Пользователь в 2026 году может добавить материал с датой `05.07.2024` — эта запись должна попадать в 2024 при фильтрации.

### 1.2 Ledger (JSONL): обязательное поле `effective_date`

Каждая ручная операция должна создавать запись в журнале с обязательным `effective_date`.

---

## 2) Изменение: список активностей и расчётов — фильтр по “реальному времени”

### 2.1 Основное правило фильтрации по умолчанию

Любые списки/таблицы “активности” должны фильтроваться **по `effective_date`**, а не по “дате создания записи” и не по `mtime` PDF.

**Пример:**

* запись создана в 2025, но `effective_date=2024-07-05` → в списках/фильтрах она должна считаться 2024 годом.

### 2.2 Главный экран: вместо старого “Lao toimingute logi”

В главном окне вместо старого лога должно быть:

* таблица **“Расчёты”** (см. §3), с фильтром по `effective_date` по умолчанию.

---

## 3) Изменение: перерасчёты за период (Period mode)

### 3.1 UI в области “Konverteerimine”

Добавить:

* чекбокс `Period mode`
* при включении показывать выбор периода: `From date` / `To date`
  >Границы периода начиная с From до To включительно
  >При пустом From или To выдавать предупреждение что период не заполнен.
  >Если From>To выводить предупреждение о том что дата начала периода должна быть раньше чем конец периода.
* кнопка `Arvuta` выполняет:

  * **Period mode ON** → расчёт за период
  * **Period mode OFF** → расчёт за выбранный месяц (как раньше)

### 3.2 Расчёт за период (логика)

При Period mode:

1. Собрать все позиции/источники, которые относятся к выбранному периоду по `effective_date`.
2. Выполнить конвертацию и суммирование результатов по материалам.
3. Вычесть суммы из склада Kumex.
4. Создать запись расчёта `CALC_DEDUCT` в ledger:

   * `effective_date`: дата выполнения расчёта (только дата, без времени)
   * `period_from`, `period_to`
   * `months_covered`: список "YYYY-MM" всех месяцев, входящих в период
   * `totals_by_material`: агрегированные суммы по материалам
   * `sources`: список PDF/PO (если доступно): номер заказа и дата заказа из PDF
   * `calc_params`: `CUT_LEN_MM`, kerf и т.п.

### 3.3 Блокировка повторного списания (месяцы “уже рассчитаны”)

После периода:

* все месяцы периода считаются **рассчитанными**,
* повторный расчёт, пересекающийся с уже рассчитанными месяцами, **запрещён**.

**Поведение при попытке:**

* показать сообщение и список месяцев конфликта;
* **не выполнять** списание.

### 3.4 Месячный расчёт (как раньше), но только для “ещё не рассчитанных месяцев”

Если Period mode выключен:

* `Arvuta` работает по выбранному месяцу,
* но месяц должен быть **не рассчитан ранее**.

### 3.5 Устойчивая реализация блокировки

Не хранить `locked_months` как абсолютное поле. Вместо этого:

* каждая запись `CALC_DEDUCT` хранит `months_covered`,
* на старте вычислять `locked_months = union(months_covered)` по всем `CALC_DEDUCT`,
* после удаления/редактирования расчёта — блокировки пересчитываются автоматически.

---

## 4) Изменение: убрать “Toimingu tüüp / + / -” и перенести смысл в поле Kogus

### 4.1 Удалить UI-элементы

Убрать из интерфейса:

* `Toimingu tüüp`
* `+ Tätndus`
* `- Mahakandmine`

### 4.2 Новая семантика поля `Kogus`

В ручном внесении материала поле `Kogus` принимает три режима:

* `число` (без знака), напр. `12.5` → **SET**: заменить `Kumex Ladu` на `12.5`
* `-число`, напр. `-3.2` → **SUB**: вычесть 3.2
* `+число`, напр. `+2.0` → **ADD**: прибавить 2.0

>Разделители между знаком и числом могут быть как пробел так и вовсе отсутствовать. При других случаях не вносить значения подсвечивая окошко красным цветом.
>Локаль для числа может быть как "," так и "."
>Ограничений на минимальные/максимальные значения нет!

**Важно:**

* в ledger сохранять нормализованный тип операции: `SET / ADD / SUB`.

---

## 5) Lao toimingute logi: перенести в popup + архивировать

### 5.1 Перенос

Окно `Lao toimingute logi` должно быть доступно как отдельный popup (кнопка/меню).

### 5.2 Архивация

Добавить действие `Archive…`:

* выбирает записи для архива (например “до даты …” или “выделенные”),
* сохраняет архив на диск,
* формат архива — отдельный файл, удобный для последующего просмотра в popup окне,
* удаляет записи из активного журнала с возможностью просмотра в другом popup окне,
* архивные записи не восстанавливаются в активный журнал после архивации.

### 5.3 Формат архива (рекомендация)

* `archive/ledger_YYYYMMDD_HHMMSS.jsonl` (или `.csv`)
* каждая запись — полный объект ledger.

---

## 6) Excel-фильтры по столбцам (в дополнение к default filter)

### 6.1 Требование

В таблицах (минимум “Расчёты”, желательно “Активности”):

* фильтр по уникальным значениям столбца,
* contains (строковый),
* диапазон (числовой),
* диапазон дат (from/to),
* “Clear filter”.

### 6.2 Совместимость с default filter

Default фильтр по `effective_date` действует всегда “по умолчанию”, а Excel-фильтры применяются поверх него.

---

## 7) Контекстное меню по ПКМ: Delete / Edit

### 7.1 Требование
На строках таблицы по ПКМ показывать меню:
- `Delete`
- `Edit`

> Примечание: отдельного `Undo` не существует. Только `Delete` и `Edit`.

### 7.2 Delete 
- удаляет выбранную запись из ledger;
- запускает **полный пересчёт состояния** (см. §8);
- если удалена запись типа `CALC_DEDUCT`, то автоматически пересчитываются `locked_months`
  (месяцы становятся доступными для повторного расчёта, если больше не покрываются другими `CALC_DEDUCT`).

### 7.3 Edit
- позволяет редактировать поля записи:
  - `effective_date` (Kuupäev/aeg)
  - `material`
  - `operation` (SET/ADD/SUB/CALC_DEDUCT)
  - `amount/qty`
  - поля периода для `CALC_DEDUCT` (period_from/to, months_covered) при необходимости
- после сохранения — **полный пересчёт**.

### 7.4 Удаление кнопки "Tühista toiming"
- кнопку `Tühista toiming` убрать из UI полностью;
- её функциональность заменена действием `Delete` по ПКМ.

### E) Контекстное меню
- по ПКМ доступны `Delete` и `Edit`;
- `Delete` удаляет запись и запускает полный пересчёт;
- после удаления `CALC_DEDUCT` соответствующие месяцы разблокируются (если не покрыты другими расчётами).

---

## 8) Пересчёт состояния склада (обязательная стратегия)

Любое изменение ledger (добавление/удаление/редактирование/undo/расчёт периода):

* должно приводить к пересчёту склада “с нуля”:

  * `current_stock = apply(ledger, initial_stock)`
  * `locked_months = union(months_covered)` по всем `CALC_DEDUCT`

Рекомендуется хранить отдельно:

* `initial_stock` (база) — файл `Initial Stock.jsonl`
* `ledger` (история) — файл `Ledger.jsonl`
* `config` — файл `Config.json` (включая путь к PDF)

---

## 9) Убрать “Määra vaikimisi”: авто-сохранение пути PDF

### 9.1 Требование

* Удалить чекбокс `Määra vaikimisi` и связанную логику.
* Всегда автоматически сохранять последний выбранный путь к папке PDF (в `Config.json`) при каждом выборе папки.
* При запуске подставлять этот путь.

---

## 10) Миграция данных

При загрузке старых данных:

* если в записи нет `effective_date`:

  * использовать `created_at` как fallback,
  * опционально добавить флаг `effective_date_inferred=true`.

Для старых записей расчёта:

* попытаться восстановить `months_covered`,
* иначе задать `months_covered=[selected_month]`.

---

## 11) Acceptance Criteria

### A) Ручное добавление с датой

* Добавить материал с `effective_date=05.07.2024` в 2026 году → запись видна в 2024 при фильтре 2024.

### B) Period mode

* Period mode ON, период 01.01.2024–31.12.2024 → `Arvuta`:

  * создаёт `CALC_DEDUCT`,
  * вычитает итог,
  * блокирует повторные расчёты за месяцы 2024.

* Повторный расчёт, пересекающийся с рассчитанными месяцами → блокируется, показывает конфликтующие месяцы.

### C) Месячный режим

* Period mode OFF:

  * месяц без расчёта → считается,
  * месяц уже рассчитан → блокируется.

### D) Excel-фильтры

* фильтры работают, очищаются, комбинируются с default filter.

### E) Контекстное меню

* Delete/Edit доступны по ПКМ и корректно инициируют пересчёт.

### F) PDF folder

* последний путь сохраняется автоматически и восстанавливается после перезапуска.

---

## 12) Implementation Notes (Codex)

* В сортировках и фильтрах первичным является `effective_date`.
* Для исключения двойного списания запрещать пересечения с `locked_months`.
* После любых правок ledger использовать стратегию **recompute from ledger**.
* Не пытаться “поправить дельтой” напрямую `current_stock` без пересчёта.
* UI-стек — Tkinter; при длительном пересчёте допускается блокировать UI/показывать прогресс.
