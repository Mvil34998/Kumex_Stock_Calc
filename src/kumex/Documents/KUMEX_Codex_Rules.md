# Kumex — правила расчёта списания POM (спецификация для Codex)

## 1) Контекст, цель и ограничения

### 1.1 Склад Kumex
- Склад клиента хранится как **10 плит**.
- Размер плиты: **1000 × 2000 × 52 мм**.
- Площадь 1 плиты: `1000*2000/1_000_000 = 2.0 м²`.
- Стартовый запас: `10 * 2.0 = 20.0 м²`.

### 1.2 Критически важное технологическое правило
- **Обрезки/остатки не возвращаются**: недоиспользованная ширина/длина после резки не считается новым складским остатком.
- Снятый слой по толщине (например, `52 → 42`) также считается **отходом**.

### 1.3 Цель алгоритма
1) Для каждой позиции посчитать требуемое количество полос ("лент") и их ширины.
2) Уложить полосы в плиты шириной 1000 мм так, чтобы:
   - **плит использовалось минимально**;
   - при равенстве — суммарный неиспользованный остаток по ширине был минимальным.
3) Выдать итог: `plates_used`, `m2_used`, `plates_left`, `m2_left`.

---

## 2) Параметры (настройки)

Обязательные константы:
- `BASE_THICKNESS_MM = 52`
- `PLATE_W_MM = 1000`
- `PLATE_L_MM = 2000`
- `STOCK_PLATES = 10`

Параметр процесса (конфиг):
- `CUT_LEN_MM` — рабочая длина ленты, из которой режутся детали.
  - по умолчанию: `CUT_LEN_MM = 2000` (лента используется по всей длине плиты)
  - если на производстве реально сначала приводят ленту к 1000 (по техпроцессу/оборудованию), допускается `CUT_LEN_MM = 1000`

Отношение слоёв к плите:
- `LAYERS_PER_PLATE = floor(PLATE_L_MM / CUT_LEN_MM)`
  - при `CUT_LEN_MM=2000` → `LAYERS_PER_PLATE=1`
  - при `CUT_LEN_MM=1000` → `LAYERS_PER_PLATE=2`

## 3) Входные данные

Алгоритм должен уметь принимать записи в одном из форматов:

### 3.1 Формат Record (унифицированный)
Минимально необходимые поля:
- `material` (строка): например `POM Valge`, `POM Must`.
- `dims_mm` (список из 3 чисел): `[a, b, c]` в мм.
- `uom` (строка или пусто): `"mm"` для метража, пусто/`"tk"` для штучных.
- `qty` (число):
  - если `uom=mm` → общая длина `L_total` в мм;
  - иначе → количество штук `N`.

Дополнительно (опционально):
- `part_number` / `source_row` — для диагностических логов.

### 3.2 Единицы измерения
- Все размеры `dims_mm` — **только в мм**.
- `qty` при `uom=mm` — **только в мм**.

---

## 4) Нормализация геометрии относительно плиты 52 мм

### 4.1 Выбор толщины детали `t` (ось Z)
Для размеров `a, b, c`:

- кандидаты: все `d`, такие что `d <= BASE_THICKNESS_MM`.
- если кандидатов нет → `ISSUE_NO_DIM_LE_BASE_THICKNESS`.
- иначе:
  - `t = max(candidates)`

**Важно:** наличие числа `52` в размерах **не требуется**.
Например, `42×32×25` корректен: `t=42`.

### 4.2 Footprint на плите
После выбора `t` удалить **один** экземпляр `t` из `(a,b,c)` (если `t` повторяется, удаляем только один).
Оставшиеся два размера — `p` и `q` (в мм).
Это прямоугольник footprint на плите.

---

## 5) Преобразование записей в "ленты" (полосы)

Понятия:
- **лента/полоса**: прямоугольник `w × CUT_LEN_MM`, который отрезается от плиты и затем расходуется.
- `w` — ширина ленты (то, что укладывается в 1000 мм по ширине плиты).

### 5.1 Штучные позиции (`uom` пустой или `tk`)
Дано: footprint `p × q`, количество `N`.

Есть 2 варианта ориентации резки из ленты длиной `CUT_LEN_MM`:
- Вариант A: `w = p`, `L = q`
- Вариант B: `w = q`, `L = p`

Ограничения варианта:
- `w <= PLATE_W_MM` (иначе лента не помещается)
- `L <= CUT_LEN_MM` (иначе деталь не помещается в длину ленты)

Для каждого допустимого варианта:
1) `k = floor(CUT_LEN_MM / L)` — сколько деталей по длине помещается в одной ленте.
2) если `k == 0` → вариант недопустим.
3) `strips = ceil(N / k)` — сколько лент нужно.
4) `W_demand = strips * w` — сколько суммарной ширины плиты потребуется под эти ленты.
5) `L_waste = strips*CUT_LEN_MM - N*L` — отход по длине внутри лент.

**Выбор варианта (локально):**
- минимизировать `W_demand`
- при равенстве — минимизировать `L_waste`
- при равенстве — минимизировать `BASE_THICKNESS_MM - t` (если нужен третий критерий)

Результат для позиции: добавить `strips` лент ширины `w`.

### 5.2 Метражные позиции (`uom = mm`)
Дано: footprint `p × q`, общая длина потребности `L_total` (мм).

Определение ширины ленты:
- `w = min(p, q)`

Определение требуемого числа лент:
- `strips = ceil(L_total / CUT_LEN_MM)`

Отход по длине (из-за невозможности вернуть остаток):
- `L_waste = strips*CUT_LEN_MM - L_total`

Результат: добавить `strips` лент ширины `w`.

---

## 6) Упаковка лент в плиты (минимальный остаток)

### 6.1 Модель
- Одна "укладка" (layer) — это набор лент ширины `w`, уложенных в ширину плиты 1000 мм.
- Вместимость слоя: `PLATE_W_MM`.
- Для одной плиты доступно `LAYERS_PER_PLATE` слоёв по длине.

### 6.2 Алгоритм упаковки (FFD)
Использовать **First-Fit Decreasing** по ширине лент:
1) Развернуть ленты в список ширин (учитывая кратности `strips`).
2) Отсортировать ширины по убыванию.
3) Идти по списку и класть каждую ленту в первый слой, где она помещается по остаточной ширине.
4) Если никуда не помещается — открыть новый слой.

Результаты упаковки:
- `layers_used` — число слоёв.
- `plates_used = ceil(layers_used / LAYERS_PER_PLATE)`
- `m2_used = plates_used * (PLATE_W_MM*PLATE_L_MM / 1_000_000)`
- `plates_left = STOCK_PLATES - plates_used`
- `m2_left = plates_left * 2.0`

Остаток по ширине в каждом слое — **отход** (не возвращается).

### 6.3 (Опционально) улучшение для глобального минимума
Для штучных позиций, у которых допустимы оба варианта A/B, можно выполнять локальный поиск:
- начать с локально выбранных вариантов;
- пересчитать упаковку;
- пробовать "переворачивать" вариант одной позиции и принимать изменение, если:
  1) уменьшилось `plates_used`, или
  2) при равном `plates_used` уменьшился суммарный отход по ширине.
Останов по отсутствию улучшений или по лимиту итераций.

---

## 7) Диагностика (issues)

Записи не должны приводить к падению скрипта. При проблеме запись отправляется в `issues`.

Рекомендуемые коды:
- `ISSUE_NO_DIM_LE_BASE_THICKNESS` — все размеры > 52 мм.
- `ISSUE_NO_FEASIBLE_ORIENTATION` — ни один из вариантов A/B не помещается (например, `L > CUT_LEN_MM`).
- `ISSUE_WIDTH_GT_PLATE` — требуемая ширина ленты `w > 1000`.
- `ISSUE_QTY_NON_POSITIVE` — qty <= 0 (в зависимости от политики: пропуск или учёт как корректировка).

---

## 8) Примеры (контрольные)

### 8.1 Профиль: 32×42×1000 (из плиты 52)
- `BASE_THICKNESS=52`
- размеры: 32, 42, 1000
- `t = max(d<=52) = 42`
- footprint: 32×1000
- если `uom=tk`, `N=2`, `CUT_LEN=2000`:
  - варианты:
    - A: w=32, L=1000 → k=2 → strips=1 → W_demand=32
    - B: w=1000, L=32 → k=62 → strips=1 → W_demand=1000
  - выбрать A
- отход по толщине (аналитика): `52-42=10 мм` (не возвращается)

### 8.2 Штучная без 52: 42×32×25 (N=25)
- `t=42`
- footprint 32×25
- при `CUT_LEN=2000`:
  - A: w=32, L=25 → k=80 → strips=1 → W_demand=32
  - B: w=25, L=32 → k=62 → strips=1 → W_demand=25
  - выбрать B

---

## 9) Выходные артефакты (рекомендуемо)

Минимальный набор:
1) `summary.json` или `summary.csv`:
   - `plates_used`, `m2_used`, `plates_left`, `m2_left`
   - `layers_used`, `LAYERS_PER_PLATE`, `CUT_LEN_MM`
   - суммарный отход по ширине (мм) и по площади (м²)
2) `plan_layers.csv`:
   - `layer_id`, `remaining_width_mm`, `strip_widths` (список)
3) `issues.csv`:
   - `material`, `dims`, `uom`, `qty`, `issue_code`, `issue_detail`



Note on quantities (bars): if the order line writes the quantity with 'mm' (e.g. '52x42x1000 - 3000mm'), treat qty as total length in millimetres (uom="mm"). If 'mm' is absent, qty is pieces (uom="tk"). Orders can mix both kinds.
